name: MinGW Build & Release (QEMU-SimulIDE GCC)

on:
  workflow_dispatch:
    inputs:
      version:
        required: true
        type: string
      prerelease:
        required: false
        default: false
        type: boolean
      notes:
        required: false
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    env:
      ZIP_NAME: qemu-simulide-windows-mingw64-${{ inputs.version }}.zip
      CFLAGS_BASE: -Daction=simuAction -Dtime=simuTime

    steps:
      # ---------------------------------------------------------
      # Checkout
      # ---------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # Setup MSYS2 (PURE GCC â€” NO CLANG)
      # ---------------------------------------------------------
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            git
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-python
            mingw-w64-x86_64-meson
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-libslirp
            mingw-w64-x86_64-libgcrypt
            mingw-w64-x86_64-pixman
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-capstone
            mingw-w64-x86_64-SDL2
            mingw-w64-x86_64-binutils
            mingw-w64-x86_64-ntldd

      # ---------------------------------------------------------
      # PURE GCC PATH
      # ---------------------------------------------------------
      - name: Fix PATH
        shell: bash
        run: echo "PATH=/mingw64/bin:/usr/bin:/bin" >> $GITHUB_ENV

      # ---------------------------------------------------------
      # Sanity check
      # ---------------------------------------------------------
      - name: GCC sanity test
        shell: msys2 {0}
        run: |
          echo "int main(){return 0;}" > test.c
          gcc -m64 test.c -o test.exe
          ./test.exe
          echo "GCC OK"

      # ---------------------------------------------------------
      # Detect libslirp
      # ---------------------------------------------------------
      - name: Detect slirp
        shell: msys2 {0}
        run: |
          if pkg-config --exists libslirp; then
            echo "SLIRP_FLAG=--enable-slirp" >> $GITHUB_ENV
            echo "SLIRP_CPPFLAGS=$(pkg-config --cflags libslirp)" >> $GITHUB_ENV
            echo "SLIRP_LDFLAGS=$(pkg-config --libs libslirp)" >> $GITHUB_ENV
          else
            echo "SLIRP_FLAG=--disable-slirp" >> $GITHUB_ENV
            echo "SLIRP_CPPFLAGS=" >> $GITHUB_ENV
            echo "SLIRP_LDFLAGS=" >> $GITHUB_ENV
          fi

      # ---------------------------------------------------------
      # Build SHIMS
      # ---------------------------------------------------------
      - name: Build shims
        shell: msys2 {0}
        run: |
          echo '#ifndef CI_SIMULIDE_SHIMS_H
          #define CI_SIMULIDE_SHIMS_H
          void stm32_f103c8_uart_action(void);
          void stm32_f103c8_timer_action(void);
          #endif' > /tmp/ci_shims.h

          echo 'void stm32_f103c8_uart_action(void) {}
          void stm32_f103c8_timer_action(void) {}' > /tmp/ci_shims.c

          gcc -m64 -c /tmp/ci_shims.c -o /tmp/ci_shims.o
          gcc-ar rcs /tmp/libci_shims.a /tmp/ci_shims.o

      # ---------------------------------------------------------
      # CONFIGURE (with hw/arena include fix!)
      # ---------------------------------------------------------
      - name: Configure QEMU
        shell: msys2 {0}
        run: |
          export PATH="/mingw64/bin:$PATH"

          ARENA="-I$(pwd)/hw/arena"
          SHIMINC="-include /tmp/ci_shims.h"
          EXTRA_CFLAGS="$ARENA $SHIMINC ${{ env.CFLAGS_BASE }} ${{ env.SLIRP_CPPFLAGS }}"
          EXTRA_LDFLAGS="${{ env.SLIRP_LDFLAGS }} /tmp/libci_shims.a"

          CC=x86_64-w64-mingw32-gcc \
          CXX=x86_64-w64-mingw32-g++ \
          AR=x86_64-w64-mingw32-gcc-ar \
          NM=x86_64-w64-mingw32-gcc-nm \
          RANLIB=x86_64-w64-mingw32-gcc-ranlib \
          LD=x86_64-w64-mingw32-ld \
          ./configure \
            --target-list=xtensa-softmmu \
            --enable-system \
            --enable-tcg \
            --enable-sdl \
            --enable-capstone \
            --extra-cflags="$EXTRA_CFLAGS" \
            --extra-ldflags="$EXTRA_LDFLAGS" \
            ${{ env.SLIRP_FLAG }} \
            --disable-werror
      # ---------------------------------------------------------
      # Build QEMU
      # ---------------------------------------------------------
      - name: Build QEMU
        shell: msys2 {0}
        run: ninja -C build -v

      # ---------------------------------------------------------
      # Symbol check
      # ---------------------------------------------------------
      - name: Check shim symbols
        shell: msys2 {0}
        run: |
          LIB=$(find build -name libcommon.a | head -n1)
          nm "$LIB" | grep -q stm32_f103c8_uart_action || exit 1

      # ---------------------------------------------------------
      # Bundle & ZIP
      # ---------------------------------------------------------
      - name: Bundle
        shell: msys2 {0}
        run: |
          EXE=$(find build -name "qemu-system-xtensa*.exe" | head -n1)
          mkdir -p bundle
          cp "$EXE" bundle/
          ntldd -R "$EXE" | awk '/=>/ {print $3}' | while read dll; do
            [ -f "$dll" ] && cp -n "$dll" bundle/
          done

      - name: ZIP
        shell: pwsh
        run: Compress-Archive -Path bundle/* -DestinationPath "${{ env.ZIP_NAME }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}
