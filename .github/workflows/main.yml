name: MinGW QEMU Pure-GCC Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Tag ex.: v0.1.0"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      # -----------------------------
      # Checkout
      # -----------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------
      # Install a CLEAN MSYS2
      # (NO CLANG / NO LLVM / NO LLD)
      # -----------------------------
      - name: Setup MSYS2 Pure GCC
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            git
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-python
            mingw-w64-x86_64-meson
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-pixman
            mingw-w64-x86_64-libslirp
            mingw-w64-x86_64-libgcrypt
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-SDL2
            mingw-w64-x86_64-capstone
            mingw-w64-x86_64-binutils

      # -----------------------------
      # FULL PATH RESET
      # -----------------------------
      - name: Fix PATH (force pure MinGW64)
        shell: bash
        run: |
          echo "PATH=/mingw64/bin:/usr/bin:/bin" >> $GITHUB_ENV

      # -----------------------------
      # Verify GCC really works
      # -----------------------------
      - name: GCC sanity test
        shell: msys2 {0}
        run: |
          echo "int main(){return 0;}" > test.c
          gcc -v
          gcc test.c -o test.exe
          ./test.exe
          echo "GCC OK"

      # -----------------------------
      # Configure QEMU
      # -----------------------------
      - name: Configure QEMU
        shell: msys2 {0}
        env:
          CC: gcc
          CXX: g++
          LD: ld
          AR: gcc-ar
          NM: gcc-nm
          RANLIB: gcc-ranlib
        run: |
          ./configure \
            --target-list=xtensa-softmmu \
            --enable-system \
            --enable-tcg \
            --enable-sdl \
            --enable-capstone \
            --disable-werror

      # -----------------------------
      # Build
      # -----------------------------
      - name: Build QEMU
        shell: msys2 {0}
        run: |
          ninja -C build -v

      # -----------------------------
      # Package
      # -----------------------------
      - name: Bundle
        shell: msys2 {0}
        run: |
          mkdir -p bundle
          cp build/qemu-system-xtensa*.exe bundle/

      - name: Zip
        shell: pwsh
        run: |
          Compress-Archive -Path bundle/* -DestinationPath qemu-${{ inputs.version }}.zip

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: qemu-${{ inputs.version }}
          path: qemu-${{ inputs.version }}.zip
