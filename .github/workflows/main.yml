name: MinGW Build & Release (QEMU-SimulIDE GCC)

on:
  workflow_dispatch:
    inputs:
      version:
        required: true
        type: string
      prerelease:
        required: false
        default: false
        type: boolean
      notes:
        required: false
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    env:
      ZIP_NAME: qemu-simulide-windows-mingw64-${{ inputs.version }}.zip
      CFLAGS_BASE: -Daction=simuAction -Dtime=simuTime

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-python
            mingw-w64-x86_64-meson
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-libslirp
            mingw-w64-x86_64-libgcrypt
            mingw-w64-x86_64-pixman
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-SDL2
            mingw-w64-x86_64-capstone
            mingw-w64-x86_64-binutils
            mingw-w64-x86_64-ntldd

      - name: Fix PATH
        shell: bash
        run: echo "PATH=/mingw64/bin:/usr/bin:/bin" >> $GITHUB_ENV

      # =========================================
      # SHIMS — criar DENTRO DO MSYS2 corretamente
      # =========================================
      - name: Criar shims (MSYS2-safe)
        shell: msys2 {0}
        run: |
          export PATH="/mingw64/bin:/usr/bin:/bin:$PATH"

          # Diretório que REALMENTE existe dentro do MSYS2
          mkdir -p build/ci_shims

          # Criar header
          cat > build/ci_shims/ci_shims.h << 'EOF'
          #ifndef CI_SIMULIDE_SHIMS_H
          #define CI_SIMULIDE_SHIMS_H
          void stm32_f103c8_uart_action(void);
          void stm32_f103c8_timer_action(void);
          #endif
          EOF

          # Criar código
          cat > build/ci_shims/ci_shims.c << 'EOF'
          void stm32_f103c8_uart_action(void) {}
          void stm32_f103c8_timer_action(void) {}
          EOF

          # Compilar dentro do MSYS2
          x86_64-w64-mingw32-gcc -m64 -c build/ci_shims/ci_shims.c -o build/ci_shims/ci_shims.o
          x86_64-w64-mingw32-gcc-ar rcs build/ci_shims/libci_shims.a build/ci_shims/ci_shims.o

          echo "Shims criados em:"
          ls -l build/ci_shims

      - name: Limpar diretório build/
        shell: msys2 {0}
        run: |
          rm -rf build
          
      - name: Garantir build limpo
        shell: msys2 {0}
        run: |
          if [ -d build ]; then
            echo "Removendo diretório build antigo..."
            rm -rf build
          fi

      # =========================================
      # CONFIGURE USANDO CAMINHOS MSYS2 CORRETOS
      # =========================================
      - name: Configure QEMU (FORÇANDO gcc MinGW64)
        shell: msys2 {0}
        run: |
          # REMOVE gcc POSIX DO PATH
          export PATH="/mingw64/bin:/usr/bin:/bin"
          hash -r

          echo "=== WHICH GCC ==="
          which gcc || echo "gcc NAO encontrado"
          ls -l /mingw64/bin/gcc || true

          SHIMS_DIR="$(pwd)/build/ci_shims"
          mkdir -p "$SHIMS_DIR"

          ARENA="-I$(pwd)/hw/arena"
          SHIMINC="-include ${SHIMS_DIR}/ci_shims.h"

          EXTRA_CFLAGS="$ARENA $SHIMINC -Daction=simuAction -Dtime=simuTime"
          EXTRA_LDFLAGS="${SHIMS_DIR}/libci_shims.a"

          # FORÇA USAR SOMENTE O COMPILADOR DO MINGW64
          export CC=/mingw64/bin/gcc
          export CXX=/mingw64/bin/g++
          export AR=/mingw64/bin/ar
          export NM=/mingw64/bin/nm
          export RANLIB=/mingw64/bin/ranlib
          export LD=/mingw64/bin/ld

          echo "=== TEST GCC ==="
          $CC --version || echo "gcc do mingw64 NAO funciona!"

          ./configure \
            --target-list=xtensa-softmmu \
            --enable-system \
            --enable-tcg \
            --enable-sdl \
            --enable-capstone \
            --extra-cflags="$EXTRA_CFLAGS" \
            --extra-ldflags="$EXTRA_LDFLAGS" \
            --disable-werror
      # ----------------------------
      # BUILD
      # ----------------------------
      - name: Build
        shell: msys2 {0}
        run: |
          export PATH="/mingw64/bin:/usr/bin:/bin:$PATH"
          ninja -C build -v

      # ----------------------------
      # Bundle
      # ----------------------------
      - name: Bundle
        shell: msys2 {0}
        run: |
          export PATH="/mingw64/bin:/usr/bin:/bin:$PATH"
          EXE=$(find build -name "qemu-system-xtensa*.exe" | head -n 1)
          mkdir -p bundle
          cp "$EXE" bundle/
          ntldd -R "$EXE" | awk '/=>/ {print $3}' | while read dll; do
            [ -f "$dll" ] && cp -n "$dll" bundle/
          done

      - name: ZIP
        shell: pwsh
        run: |
          Compress-Archive -Path bundle\* -DestinationPath "${{ env.ZIP_NAME }}"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}
